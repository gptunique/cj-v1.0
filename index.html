<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CJ대한통운 대량조회 - 독립형 버전</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body {font-family:'Malgun Gothic',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);margin:0;padding:20px;}
.container {max-width:1100px;margin:20px auto;background:white;border-radius:15px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,0.2);}
.header {background:#E60012;color:white;padding:25px;text-align:center;font-size:28px;border-radius:10px;margin-bottom:25px;}
.header small {display:block;font-size:14px;margin-top:8px;opacity:0.9;}
.input-area {padding:30px;background:#f8fbff;text-align:center;}
textarea {width:95%;max-width:900px;height:200px;border:2px solid #E60012;border-radius:8px;padding:15px;font-size:16px;font-family:'Malgun Gothic',sans-serif;}
.btn {margin-top:15px;padding:16px 40px;background:#E60012;color:white;border:none;border-radius:8px;font-size:18px;cursor:pointer;font-weight:bold;transition:all 0.3s;}
.btn:hover {background:#C70011;transform:translateY(-2px);}
.result-area {padding:30px;min-height:300px;}
.log {text-align:center;padding:18px;background:#e3f2fd;color:#00695c;font-size:16px;border-radius:8px;margin-bottom:20px;}
table {width:100%;border-collapse:collapse;margin-top:15px;box-shadow:0 3px 10px rgba(0,0,0,0.1);}
th {background:#E60012;color:white;padding:15px;}
td {padding:12px;border-bottom:1px solid #eee;text-align:center;}
.status-done {background:#e8f5e8 !important;color:#1b5e20;font-weight:bold;}
.status-ing {background:#fff8e1 !important;color:#e65100;font-weight:bold;}
.status-wait {background:#e1f5fe !important;color:#01579b;}
.status-fail {background:#ffebee !important;color:#c62828;}
.detail-btn {background:none;border:none;color:#E60012;font-weight:bold;cursor:pointer;text-decoration:underline;}
.detail-btn:hover {color:#C70011;}
.detail-box {margin:30px 0;padding:25px;background:#f8fbff;border:2px solid #E60012;border-radius:10px;}
.delivery-step {display:flex;justify-content:space-between;margin:25px 0;position:relative;}
.delivery-step::before {content:'';position:absolute;top:40px;left:5%;right:5%;height:4px;background:#ddd;z-index:1;}
.step {flex:1;text-align:center;z-index:3;}
.circle {width:50px;height:50px;border-radius:50%;background:#ddd;color:#666;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:bold;transition:all 0.3s;}
.step.on .circle {background:#E60012;color:white;}
.step-label {font-size:13px;color:#444;}
.track-table {width:100%;margin-top:20px;border-collapse:collapse;}
.track-table th {background:#E60012;color:white;padding:12px;}
.track-table td {padding:10px;border:1px solid #ddd;}
.btn-group {text-align:center;margin:40px 0;}
.btn-save {padding:14px 35px;margin:10px;border:none;border-radius:50px;cursor:pointer;font-size:16px;font-weight:bold;transition:all 0.3s;}
.btn-save.csv {background:#43a047;color:white;}
.btn-save.excel {background:#fb8c00;color:white;}
.btn-save:hover {transform:scale(1.05);box-shadow:0 5px 15px rgba(0,0,0,0.3);}
footer {text-align:center;padding:20px;color:white;font-size:12px;}
</style>
</head>
<body>
<div class="container">
<div class="header">
CJ대한통운 실시간 대량조회 (독립형)
<small>서버 불필요 · 바로 사용 가능 · 엑셀/CSV 저장</small>
</div>

<div class="input-area">
<textarea id="numbers" placeholder="송장번호를 한 줄에 하나씩 입력하세요 (최대 30개)
예시:
694695227666
694695227670"></textarea>
<button class="btn" onclick="start()">조회 시작</button>
</div>

<div class="result-area">
<div id="log" class="log">송장번호를 입력하고 [조회 시작] 버튼을 눌러주세요</div>
<div id="result"></div>
</div>
</div>

<footer>
CJ대한통운 대량조회 전용 · 완전 무료 · 개인정보 수집 없음
</footer>

<script>
// AllOrigins 프록시 사용 (무료, 안정적)
async function fetchWithProxy(url) {
try {
const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
const response = await fetch(proxyUrl);
const data = await response.json();
return data.contents;
} catch (error) {
console.error('Proxy error:', error);
throw error;
}
}

let allResults = [];

async function query(num) {
// CJ 공식 조회 페이지
const url = `https://www.cjlogistics.com/ko/tool/parcel/tracking-detail?invcNo=${num}`;
try {
const html = await fetchWithProxy(url);
const parser = new DOMParser();
const doc = parser.parseFromString(html, "text/html");

let status = "조회불가", location = "정보없음", progress = 0;
const tracks = [];

// HTML에서 배송 정보 추출
const bodyText = doc.body.textContent || '';

// 배송 상태 판별
if (bodyText.includes('배송완료') || bodyText.includes('배달완료')) {
status = "배송완료";
location = "배송 완료";
progress = 100;
} else if (bodyText.includes('배송출발') || bodyText.includes('배달출발')) {
status = "배송출발";
location = "배송 중";
progress = 75;
} else if (bodyText.includes('배송중') || bodyText.includes('배달중')) {
status = "배송중";
location = "배송 중";
progress = 70;
} else if (bodyText.includes('터미널') || bodyText.includes('HUB')) {
status = "터미널 도착";
location = "터미널";
progress = 50;
} else if (bodyText.includes('간선상차') || bodyText.includes('간선하차')) {
status = "간선 이동";
location = "이동 중";
progress = 40;
} else if (bodyText.includes('집화완료') || bodyText.includes('상품인수')) {
status = "집화완료";
location = "집하 완료";
progress = 25;
} else if (bodyText.includes('접수') || bodyText.includes('상품접수')) {
status = "접수완료";
location = "접수";
progress = 10;
}

// 테이블 데이터 추출 시도
const tables = doc.querySelectorAll('table');
for (const table of tables) {
const rows = table.querySelectorAll('tbody tr');
if (rows.length > 0) {
rows.forEach(row => {
const cells = row.querySelectorAll('td');
if (cells.length >= 3) {
const text1 = cells[0]?.textContent.trim() || '';
const text2 = cells[1]?.textContent.trim() || '';
const text3 = cells[2]?.textContent.trim() || '';
if (text1 && (text1.includes('-') || text1.includes(':'))) {
tracks.push({
date: text1,
place: text2,
desc: text3
});
}
}
});
if (tracks.length > 0) break;
}
}

return {status, location, progress, tracks: tracks.slice(0,20)};
} catch (e) {
console.error("Query error:", e);
return {status:"조회실패", location:"네트워크 오류", progress:0, tracks:[]};
}
}

async function start() {
const input = document.getElementById("numbers").value.trim();
if (!input) return alert("송장번호를 입력해주세요!");
const nums = input.split("\n").map(x=>x.trim()).filter(x=>x);

if (nums.length > 30) {
return alert("최대 30개까지만 조회 가능합니다!");
}

document.getElementById("result").innerHTML = `<table id="tbl"><tr><th>순번</th><th>송장번호</th><th>상태</th><th>위치</th><th>상세보기</th></tr></table>`;
document.getElementById("log").innerHTML = `<div class="log">조회 시작중... (총 ${nums.length}건)</div>`;
allResults = [];
const table = document.getElementById("tbl");

for (let i = 0; i < nums.length; i++) {
document.getElementById("log").innerHTML = `<div class="log">조회 중 → ${i+1}/${nums.length}</div>`;
const res = await query(nums[i]);

allResults.push({
순번: i+1,
송장번호: nums[i],
상태: res.status,
위치: res.location,
진행도: res.progress + '%',
상세이력: res.tracks.map(t=>`${t.date} | ${t.place} | ${t.desc}`).join('\n')
});

const row = table.insertRow();
row.className = res.status.includes("완료")?'status-done':res.status.includes("배송중")?'status-ing':res.status.includes("터미널")?'status-wait':'';
row.innerHTML = `<td>${i+1}</td><td><strong>${nums[i]}</strong></td><td>${res.status}</td><td>${res.location}</td>
<td><button class="detail-btn" onclick="showDetail(${i})">상세보기</button></td>`;

// 프록시 서버 부하 방지
await new Promise(r=>setTimeout(r, 1500));
}

document.getElementById("log").innerHTML = `<div class="log" style="background:#e8f5e8">조회 완료! 총 ${nums.length}건 처리 완료</div>`;
document.getElementById("result").innerHTML += `<div class="btn-group">
<button class="btn-save csv" onclick="saveCSV()">CSV 저장</button>
<button class="btn-save excel" onclick="saveExcel()">엑셀 저장</button>
</div>`;
}

function showDetail(i) {
document.querySelectorAll(".detail-box").forEach(d=>d.remove());
const d = allResults[i];
const progress = parseInt(d.진행도);

const html = `<div class="detail-box" style="display:block">
<h3>운송장번호: ${d.송장번호} → ${d.상태}</h3>
<div class="delivery-step">
<div class="step ${progress>=10?'on':''}"><div class="circle">1</div><div class="step-label">접수</div></div>
<div class="step ${progress>=25?'on':''}"><div class="circle">2</div><div class="step-label">집화</div></div>
<div class="step ${progress>=50?'on':''}"><div class="circle">3</div><div class="step-label">터미널</div></div>
<div class="step ${progress>=75?'on':''}"><div class="circle">4</div><div class="step-label">배송출발</div></div>
<div class="step ${progress>=100?'on':''}"><div class="circle">5</div><div class="step-label">배송완료</div></div>
</div>
<table class="track-table"><tr><th>일시</th><th>위치</th><th>상세내역</th></tr>
${d.상세이력 ? d.상세이력.split("\n").map(l => {
const parts = l.split(" | ");
return `<tr><td>${parts[0]||""}</td><td>${parts[1]||""}</td><td>${parts[2]||""}</td></tr>`;
}).join("") : "<tr><td colspan=3>내역 없음</td></tr>"}
</table>
</div>`;

const btn = event.target;
btn.parentElement.parentElement.insertAdjacentHTML("afterend", html);
}

function saveCSV() {
let csv = "\uFEFF순번,송장번호,상태,위치,진행도,상세이력\n" + allResults.map(r=>`${r.순번},"${r.송장번호}","${r.상태}","${r.위치}","${r.진행도}","${r.상세이력.replace(/"/g,'""')}"`).join("\n");
const a = document.createElement("a");
a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8"}));
a.download = `CJ대한통운_조회결과_${new Date().toISOString().slice(0,10)}.csv`;
a.click();
}

function saveExcel() {
const data = allResults.map(r=>({순번:r.순번,송장번호:r.송장번호,상태:r.상태,위치:r.위치,진행도:r.진행도,상세이력:r.상세이력}));
const wb = XLSX.utils.book_new();
const ws = XLSX.utils.json_to_sheet(data);
ws["!cols"] = [{wch:8},{wch:16},{wch:12},{wch:20},{wch:12},{wch:60}];
XLSX.utils.book_append_sheet(wb,ws,"CJ대한통운");
XLSX.writeFile(wb,`CJ대한통운_조회결과_${new Date().toISOString().slice(0,10)}.xlsx`);
}
</script>
</body>
</html>
